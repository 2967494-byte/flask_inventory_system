{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è "–•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏" -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">–ì–ª–∞–≤–Ω–∞—è</a></li>
            {% if product.category %}
                <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}?category_id={{ product.category.id }}">
                    {{ product.category.name }}
                </a></li>
            {% endif %}
            <li class="breadcrumb-item active" aria-current="page">{{ product.title|truncate(50) }}</li>
        </ol>
    </nav>
    
    <!-- –ë–∞–Ω–Ω–µ—Ä —Å—Ç–∞—Ç—É—Å–∞ -->
    {% if product.status != product.STATUS_PUBLISHED %}
    <div class="status-banner {% if product.status == product.STATUS_READY_FOR_PUBLICATION %}status-ready{% elif product.status == product.STATUS_UNPUBLISHED %}status-unpublished{% else %}status-review{% endif %} mb-4">
        {% if product.status == product.STATUS_READY_FOR_PUBLICATION %}
        ‚è∞ –°—Ä–æ–∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∏—Å—Ç–µ–∫. –¢–æ–≤–∞—Ä –≤–∏–¥–µ–Ω —Ç–æ–ª—å–∫–æ –≤–∞–º.
        {% elif product.status == product.STATUS_UNPUBLISHED %}
        üö´ –¢–æ–≤–∞—Ä —Å–Ω—è—Ç —Å –ø—É–±–ª–∏–∫–∞—Ü–∏–∏. –í–∏–¥–µ–Ω —Ç–æ–ª—å–∫–æ –≤–∞–º.
        {% else %}
        üîç –¢–æ–≤–∞—Ä –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ
        {% endif %}
    </div>
    {% endif %}
    
    <div class="product-details-container">
        <div class="product-layout">
            <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ì–∞–ª–µ—Ä–µ—è –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <div class="product-left-column">
                <!-- –ì–∞–ª–µ—Ä–µ—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
                <div class="product-gallery mb-4">
                    {% if product.images and product.images|length > 0 %}
                        <div class="main-image">
                            <img src="{{ url_for('main.serve_uploaded_file', filename=product.images[0]) }}" 
                                 alt="{{ product.title }}" 
                                 id="mainImage"
                                 onerror="this.src='/static/images/no-image.png'">
                        </div>
                        {% if product.images|length > 1 %}
                        <div class="image-thumbnails mt-3">
                            {% for image in product.images %}
                            <img src="{{ url_for('main.serve_uploaded_file', filename=image) }}" 
                                 alt="{{ product.title }}" 
                                 class="thumbnail {% if loop.first %}active{% endif %}"
                                 onclick="changeImage(this)"
                                 onerror="this.src='/static/images/no-image.png'">
                            {% endfor %}
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="main-image no-image d-flex align-items-center justify-content-center">
                            <div class="text-center">
                                <div class="no-image-icon text-muted mb-2">
                                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                        <polyline points="21 15 16 10 5 21"></polyline>
                                    </svg>
                                </div>
                                <span class="text-muted">–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</span>
                            </div>
                        </div>
                    {% endif %}
                </div>
                
                <!-- –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Ç–æ–≤–∞—Ä–∞ -->
                <div class="product-specs-card mb-4">
                    <h3 class="mb-3"><i class="specs-icon">üìã</i> –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</h3>
                    <div class="specs-grid">
                        {% if product.manufacturer %}
                        <div class="spec-item">
                            <span class="spec-label">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å</span>
                            <span class="spec-value">{{ product.manufacturer }}</span>
                        </div>
                        {% endif %}
                        
                        <div class="spec-item">
                            <span class="spec-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</span>
                            <span class="spec-value">{{ product.quantity }} —à—Ç.</span>
                        </div>
                        
                        <div class="spec-item">
                            <span class="spec-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</span>
                            <span class="spec-value">{{ product.category.name if product.category else '–ù–µ —É–∫–∞–∑–∞–Ω–∞' }}</span>
                        </div>
                        
                        <div class="spec-item">
                            <span class="spec-label">–î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è</span>
                            <span class="spec-value">{{ product.created_at.strftime('%d.%m.%Y') }}</span>
                        </div>
                    </div>
                </div>
                
                <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
                <div class="product-description-card">
                    <h3 class="mb-3"><i class="description-icon">üìù</i> –û–ø–∏—Å–∞–Ω–∏–µ</h3>
                    <div class="product-description-text text-muted">
                        {{ product.description or '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç' }}
                    </div>
                </div>
            </div>
            
            <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –¶–µ–Ω–∞, –∫–æ–Ω—Ç–∞–∫—Ç—ã, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
            <div class="product-right-column">
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
                <div class="product-title-section mb-4">
                    <h1 class="product-title">{{ product.title }}</h1>
                    {% if product.manufacturer %}
                    <div class="product-manufacturer text-muted">
                        <span class="manufacturer-label">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å:</span>
                        <span class="manufacturer-value">{{ product.manufacturer }}</span>
                    </div>
                    {% endif %}
                </div>
                
                <!-- –ë–ª–æ–∫ —Ü–µ–Ω—ã -->
                <div class="price-section mb-4 p-4 bg-white border rounded shadow-sm">
                    <div class="product-price-large mb-2">{{ "%.2f"|format(product.price) }} ‚ÇΩ</div>
                    
                    {% if product.quantity > 1 %}
                    <div class="product-quantity text-muted mb-2">
                        <i class="quantity-icon">üì¶</i>
                        <span>–í –Ω–∞–ª–∏—á–∏–∏: {{ product.quantity }} —à—Ç.</span>
                    </div>
                    {% endif %}
                    
                    <!-- –ù–î–° -->
                    <div class="vat-status">
                        {% if product.vat_included %}
                            <span class="vat-label vat-included">–° –ù–î–°</span>
                        {% else %}
                            <span class="vat-label vat-excluded">–ë–µ–∑ –ù–î–°</span>
                        {% endif %}
                    </div>
                </div>
                
                <!-- –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                {% if product.status == product.STATUS_PUBLISHED or current_user.id == product.user_id %}
                <div class="contact-section-modern mb-4 p-4 bg-white border rounded shadow-sm">
                    <div class="d-flex align-items-center mb-3">
                        <div class="seller-avatar me-3">
                            <i class="avatar-icon">üë§</i>
                        </div>
                        <div class="seller-details">
                            <div class="seller-name fw-bold">
                                {% if product.owner.username %}
                                    {{ product.owner.username }}
                                {% elif product.owner.company_name %}
                                    {{ product.owner.company_name }}
                                {% else %}
                                    {{ product.owner.email.split('@')[0] }}
                                {% endif %}
                            </div>
                            <div class="seller-rating">
                                <span class="stars text-warning">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
                                <span class="rating-text text-muted ms-1">5.0 ‚Ä¢ 1 –æ—Ç–∑—ã–≤</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="contact-actions">
                        {% if product.owner.phone and current_user.is_authenticated %}
                        <button class="btn btn-outline-primary w-100 mb-2" onclick="showFullPhone()">
                            <i class="button-icon">üì±</i>
                            –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω
                            <span class="phone-number ms-1 opacity-75">{{ product.owner.phone[:5] }} XXX-XX-XX</span>
                        </button>
                        {% endif %}
                        
                        {% if current_user.is_authenticated %}
                        <a href="{{ url_for('main.messages', user_id=product.user_id, product_id=product.id) }}" 
                           class="btn btn-outline-primary w-100 mb-2">
                            <i class="button-icon">‚úâÔ∏è</i>
                            –ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
                        </a>
                        {% endif %}
                        
                        {% if current_user.is_authenticated %}
                        <form method="POST" action="{{ url_for('main.toggle_favorite', product_id=product.id) }}" class="mb-2">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn {% if product in current_user.favorited_products %}btn-outline-danger{% else %}btn-outline-primary{% endif %} w-100">
                                <i class="button-icon">{% if product in current_user.favorited_products %}üíî{% else %}‚ù§Ô∏è{% endif %}</i>
                                {% if product in current_user.favorited_products %}
                                    –£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
                                {% else %}
                                    –î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
                                {% endif %}
                            </button>
                        </form>
                        {% endif %}
                        
                        <button class="btn btn-outline-warning w-100" onclick="reportProduct()">
                            <i class="button-icon">üö®</i>
                            –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è –Ω–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ
                        </button>
                    </div>
                </div>
                {% endif %}
                
                <!-- –î–µ–π—Å—Ç–≤–∏—è —Å —Ç–æ–≤–∞—Ä–æ–º (–¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞/–∞–¥–º–∏–Ω–∞) -->
                {% if current_user.id == product.user_id or current_user.role == 'admin' %}
                <div class="product-actions-modern p-4 bg-white border rounded shadow-sm">
                    <h3 class="mb-3"><i class="actions-icon">‚öôÔ∏è</i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–º</h3>
                    <div class="d-grid gap-2">
                        {% if current_user.id == product.user_id %}
                        <a href="{{ url_for('main.edit_product', product_id=product.id) }}" class="btn btn-outline-primary">
                            <i class="action-modern-icon">‚úèÔ∏è</i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                        </a>
                        {% endif %}
                        
                        {% if product.status == product.STATUS_PUBLISHED and current_user.id == product.user_id %}
                        <form method="POST" action="{{ url_for('main.unpublish_product', product_id=product.id) }}" 
                              onsubmit="return confirm('–°–Ω—è—Ç—å —Ç–æ–≤–∞—Ä —Å –ø—É–±–ª–∏–∫–∞—Ü–∏–∏? –û–Ω —Å—Ç–∞–Ω–µ—Ç –≤–∏–¥–µ–Ω —Ç–æ–ª—å–∫–æ –≤–∞–º.')">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-outline-warning w-100">
                                <i class="action-modern-icon">‚è∏Ô∏è</i> –°–Ω—è—Ç—å —Å –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
                            </button>
                        </form>
                        {% endif %}
                        
                        {% if product.status in [product.STATUS_READY_FOR_PUBLICATION, product.STATUS_UNPUBLISHED] and current_user.id == product.user_id %}
                        <form method="POST" action="{{ url_for('main.renew_product', product_id=product.id) }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-outline-success w-100">
                                <i class="action-modern-icon">üì§</i> –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å
                            </button>
                        </form>
                        {% endif %}
                        
                        <form method="POST" action="{{ url_for('main.delete_product', product_id=product.id) }}" 
                              onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä?')">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-outline-danger w-100">
                                <i class="action-modern-icon">üóëÔ∏è</i> –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä
                            </button>
                        </form>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ -->
<div id="phoneModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="closePhoneModal()">&times;</span>
        <h3>–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω</h3>
        <p class="fs-2 fw-bold text-center">{{ product.owner.phone }}</p>
        <div class="text-center mt-3">
            <a href="tel:{{ product.owner.phone }}" class="btn btn-primary">–ü–æ–∑–≤–æ–Ω–∏—Ç—å</a>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∂–∞–ª–æ–±—ã -->
<div id="reportModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="closeReportModal()">&times;</span>
        <h3>–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è –Ω–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h3>
        <form method="POST" action="{{ url_for('main.report_product', product_id=product.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="mb-3">
                <label class="form-label">–ü—Ä–∏—á–∏–Ω–∞ –∂–∞–ª–æ–±—ã:</label>
                <select name="reason" class="form-select" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É</option>
                    <option value="fraud">–ú–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ</option>
                    <option value="spam">–°–ø–∞–º</option>
                    <option value="inappropriate">–ù–µ–ø—Ä–∏–µ–º–ª–µ–º—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç</option>
                    <option value="other">–î—Ä—É–≥–æ–µ</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∂–∞–ª–æ–±—É</button>
        </form>
    </div>
</div>

<script>
function changeImage(thumb) {
    const mainImage = document.getElementById('mainImage');
    if (mainImage) {
        mainImage.src = thumb.src;
    }
    document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
    thumb.classList.add('active');
}

function showFullPhone() {
    document.getElementById('phoneModal').style.display = 'block';
}

function closePhoneModal() {
    document.getElementById('phoneModal').style.display = 'none';
}

function reportProduct() {
    document.getElementById('reportModal').style.display = 'block';
}

function closeReportModal() {
    document.getElementById('reportModal').style.display = 'none';
}

window.onclick = function(event) {
    const phoneModal = document.getElementById('phoneModal');
    const reportModal = document.getElementById('reportModal');
    if (event.target == phoneModal) phoneModal.style.display = 'none';
    if (event.target == reportModal) reportModal.style.display = 'none';
}

document.addEventListener('DOMContentLoaded', function() {
    const images = document.querySelectorAll('.product-gallery img');
    images.forEach(img => {
        img.addEventListener('error', function() {
            this.src = '/static/images/no-image.png';
        });
    });
});
</script>
{% endblock %}