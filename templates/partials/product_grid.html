<div class="product-grid-v2">
    {% for product in products %}
    {% set root_category = product.product_category.get_ancestors()[0] if product.product_category else none %}
    {% set border_color = root_category.color if root_category and root_category.color else '#e0e0e0' %}
    <div class="product-card-v2" style="border: 2px solid {{ border_color }};"
        onclick="location.href='{{ url_for('main.product_detail', product_id=product.id) }}'">

        <!-- Image Area -->
        <div class="card-image-wrapper">
            <!-- Location Overlay -->
            <div class="location-overlay-v2">
                {% if product.city %}{{ product.city }}{% endif %}
                {% if product.region and product.city %}, {% endif %}
                {% if product.region %}{{ product.region }}{% endif %}
            </div>

            <!-- Mobile Favorite Icon (Top Right) -->
            {% if current_user.is_authenticated %}
            <div class="favorite-btn-v2 mobile-favorite-icon"
                onclick="toggleFavorite(event, {{ product.id }}, '{{ csrf_token() }}')">
                <div class="favorite-icon-container" data-product-id="{{ product.id }}"
                    data-is-favorited="{{ 'true' if product in current_user.favorited_products else 'false' }}">

                    <svg class="heart-filled" width="16" height="16" viewBox="0 0 24 24" fill="#FF0000" stroke="#FF0000"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        style="display: {{ 'block' if product in current_user.favorited_products else 'none' }};">
                        <path
                            d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z">
                        </path>
                    </svg>

                    <svg class="heart-outline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#8D8D8D"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        style="display: {{ 'none' if product in current_user.favorited_products else 'block' }};">
                        <path
                            d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z">
                        </path>
                    </svg>
                </div>
            </div>
            {% endif %}

            <!-- Image Logic -->
            {% set image_list = product.images | deserialize_images %}
            {% if image_list | length > 0 %}
            <img src="{{ url_for('main.serve_uploaded_file', filename=image_list[0]) }}" alt="{{ product.title }}"
                onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div class="no-photo-v2" style="display: none;">
                <svg class="category-placeholder" width="100%" height="100%" viewBox="0 0 150 150"
                    preserveAspectRatio="none" data-category-id="{{ product.product_category.id }}">
                    <rect width="100%" height="100%" fill="{{ product.product_category.color|default('#ccc') }}" />
                    <text x="50%" y="50%" text-anchor="middle" dy=".3em" font-family="Arial" font-size="16" fill="white"
                        font-weight="500">
                        {{ product.product_category.name|truncate(15) }}
                    </text>
                </svg>
            </div>
            {% else %}
            <div class="no-photo-v2">
                <svg class="category-placeholder" width="100%" height="100%" viewBox="0 0 150 150"
                    preserveAspectRatio="none" data-category-id="{{ product.product_category.id }}">
                    <rect width="100%" height="100%" fill="{{ product.product_category.color|default('#ccc') }}" />
                    <text x="50%" y="50%" text-anchor="middle" dy=".3em" font-family="Arial" font-size="16" fill="white"
                        font-weight="500">
                        {{ product.product_category.name|truncate(15) }}
                    </text>
                </svg>
            </div>
            {% endif %}
        </div>

        <!-- Info Area -->
        <div class="card-info">
            <!-- Title -->
            <div class="card-title">{{ product.title }}</div>

            <!-- Price -->
            <div class="card-price">
                {{ product|format_product_price }}
                {% if product.vat_included %}
                <span class="vat-status" style="font-size: 13px; margin-left: 6px; font-weight: bold; color: #28a745;">с
                    НДС</span>
                {% else %}
                <span class="vat-status"
                    style="font-size: 13px; margin-left: 6px; font-weight: bold; color: #dc3545;">без НДС</span>
                {% endif %}
            </div>

            <!-- Meta: Date, Views, Favorite -->
            <div class="card-meta">
                <span>{{ product.created_at.strftime('%d.%m') }}</span>

                <div style="margin-left: auto; display: flex; align-items: center; gap: 12px;">
                    <!-- Views -->
                    <span style="display: flex; align-items: center; gap: 4px;" title="Просмотры">
                        <img src="{{ url_for('static', filename='icons/eye_icon.svg') }}" alt=""
                            style="width: 12px; height: 12px; opacity: 0.6;">
                        {{ product.view_count if product.view_count else 0 }}
                    </span>

                    <!-- Favorite Heart -->
                    {% if current_user.is_authenticated %}
                    <button type="button" class="favorite-toggle-btn"
                        onclick="toggleFavorite(event, {{ product.id }}, '{{ csrf_token() }}')"
                        style="background:none; border:none; padding:0; cursor:pointer; display:flex; align-items:center;"
                        title="В избранное">

                        <div id="favorite-icon-{{ product.id }}" class="favorite-icon-container"
                            data-product-id="{{ product.id }}"
                            data-is-favorited="{{ 'true' if product in current_user.favorited_products else 'false' }}">

                            <!-- Filled Heart (shown if favorited) -->
                            <svg class="heart-filled" width="18" height="18" viewBox="0 0 24 24" fill="#FF0000"
                                stroke="#FF0000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                style="display: {{ 'block' if product in current_user.favorited_products else 'none' }};">
                                <path
                                    d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z">
                                </path>
                            </svg>

                            <!-- Outline Heart (shown if NOT favorited) -->
                            <svg class="heart-outline" width="18" height="18" viewBox="0 0 24 24" fill="none"
                                stroke="#8D8D8D" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                style="display: {{ 'none' if product in current_user.favorited_products else 'block' }};"
                                onmouseover="this.style.stroke='#FF0000'" onmouseout="this.style.stroke='#8D8D8D'">
                                <path
                                    d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z">
                                </path>
                            </svg>
                        </div>
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>

    </div>
    {% endfor %}
</div>